## Geographic Aggregation {#sec-energy-intro .unnumbered}

```{r}
#| echo: false
#| message: false
#| warning: false
library(here)
invisible(capture.output(source(here("scripts", "global.R"))))
invisible(capture.output(source(here("scripts", "helpers.R"))))

# prep data
x <- get_burn()
data <- get_damage_grid() %>% left_join(x) %>% replace_na(list(burn_cost = 0))

```

::: {.callout-tip title="Summary"}

We explore how geographic aggregation — from municipality to district to country level — affects the shape of the burn cost distribution. This helps us understand the source of small non-zero values.

:::

To better understand why there are so many data points close to zero but not exactly zero, we analyze how the data behaves when aggregated at different geographic levels.

---


### Aggregated to District Level

We recreate the earlier range plots, but now aggregate the data to the district level. That is, we have one entry per district–year–crop combination.

```{r, fig.height=7, fig.width=10}
#| warning: false
#| eval: true
#| echo: false
#| message: false

data %>% 
  damage_aggregate(grouper_vars = c("year", "crop_key", "district_name")) %>%
  plot_4_ranges(col="darkred")

```


### Aggregated to Country Level

We further aggregate the data to the country level, producing just one entry for each year and crop.


```{r, fig.height=7, fig.width=10}
#| warning: false
#| eval: true
#| echo: false
#| message: false

data %>% 
  damage_aggregate(grouper_vars = c("year", "crop_key")) %>%
  plot_4_ranges(col="orange")

```




### Aggregation Effect
The following plots compare the distribution of positive burn values across three levels of geographic aggregation:

- Municipality level (blue)
- District level (green, for a high-damage crop)
- Country level (red, for one specific year)

This helps us visualize what happens to the distribution — especially the small-damage region — as we aggregate more.

```{r, fig.height=7, fig.width=10}
#| warning: false
#| eval: true
#| echo: false
#| message: false

pA <- plot_3_aggregations(data, col = "darkblue")
pB <- plot_3_aggregations(data,  cps = c("maca"), col = "darkgreen")
pC <- plot_3_aggregations(data,  yrs = c(2022), col = "darkred")

combined_plot <- (pA | pB | pC) +
  plot_annotation(title = "Aggregations entire range and < SB range",
                  theme = theme(plot.title = element_text(hjust = 0.5)))
combined_plot

```


### Reasoning

::: {.callout-important title="Why do we have so many small damages"}

In some way, it doesn't make sense to have claims smaller than 1% — no farmer would bother claiming that. The likely explanation is aggregation dilution: when a single event affects a small part of a large area, the burn cost gets spread thinly over the full insured area. As we move from municipality to district to country, this effect should become more visible. The charts above suggest this pattern — especially for all crops combined — but it's not entirely conclusive. We will test this hypothesis further in the next section.

:::