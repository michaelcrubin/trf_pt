<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>gamma</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="gamma_files/libs/clipboard/clipboard.min.js"></script>
<script src="gamma_files/libs/quarto-html/quarto.js"></script>
<script src="gamma_files/libs/quarto-html/popper.min.js"></script>
<script src="gamma_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="gamma_files/libs/quarto-html/anchor.min.js"></script>
<link href="gamma_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="gamma_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="gamma_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="gamma_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="gamma_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">



<section id="sec-energy-intro" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="sec-energy-intro">Aggretation Effect on Gammas</h2>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body" title="Exponentials, Erlang">
<p>None of the models is performs fully satisfactory for our use. The main issues are overfittig to the known stations and extremly large individual errors. Furthermore, some locations and models are fully biased and there is no clear explanatory patters (geography etc.). Models which perform better on precision tend to be less generalizable, further underpinning the overfitting argument.</p>
<p><strong>Conclusion</strong>: we need to learn to work with partially unreliable data.</p>
</div>
</div>
<div class="cell">

</div>
<section id="problem-setting" class="level3">
<h3 class="anchored" data-anchor-id="problem-setting">Problem Setting</h3>
<p>We define that each field is a atomic damage unit, which is governed by a probabilistic function P with some parameter θ. In our data, we do not see any of the k fields, we only see the aggregated effects of k fields. Also, we do not know the parameter k (how many fields).</p>
<p>We assume that the damage in a given field follows an exponential function with parameter lambda = 1/θ. Exponential tells that damages near zero are most likely and get increasingly unlikely the larger x.</p>
<p>Our first goal is to understand the effects of aggregation on such a situaiton. Therefore, we start with a simple experiment.</p>
</section>
<section id="theory" class="level3">
<h3 class="anchored" data-anchor-id="theory">Theory</h3>
<p>An Exponential Exp(1/θ) is a special case of a Gamma(1, θ). In fact, the entire justification of Erlang, which is a special case of Gamma with alpha = int, is the aggregation (sum, mean) of k Exp(1/θ). Hence, we can say that averaging k Exp(1/θ) ⇒ Gamma(k, θ/k). If we hypthesize that the atomic unit of damage does not follow Exp(1/θ), but Gamma(alpha,θ) with some shape parameter alpha, then little changes. k Gamma(alpha,θ) ⇒ Gamma(alpha*k, θ/k).</p>
</section>
<section id="simulations-exponentials" class="level3">
<h3 class="anchored" data-anchor-id="simulations-exponentials">Simulations Exponentials</h3>
<p>We run monte carlo simulations of 50’000 draws of Exp(1/θ). With 50’000 draws we are very close to the theory. We compare the empirical average to the Theoretical Gamma(k, θ/k) (Erlang), which should be the theoretical aggregated distribution. We compare then the theoretical distribution to the empirical average and the Expected value of all Exp(1/θ) to θ.</p>
<p><strong>We do it for 3 different θ:</strong></p>
<div class="cell">

</div>
<div class="cell">
<div class="cell-output-display">
<p><img src="gamma_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="960"></p>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<p><img src="gamma_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="960"></p>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<p><img src="gamma_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid" width="960"></p>
</div>
</div>
<section id="why-does-empirical-average-diverge-at-small-theta" class="level4">
<h4 class="anchored" data-anchor-id="why-does-empirical-average-diverge-at-small-theta">Why does empirical average diverge at small theta</h4>
<p>We observe a strange behavour of the empirical average (blue). The problem is only the plotting function after_stat(density). Because it uses Gaussian Kerneling, the near-zero Gaussians leak to &lt;0 and hence distort the smoothing function. If you look at a hist of the empirical average, it looks perfectly gamma.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="gamma_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="960"></p>
</div>
</div>
</section>
</section>
<section id="simulations-gammas" class="level3">
<h3 class="anchored" data-anchor-id="simulations-gammas">Simulations Gammas</h3>
<p>It is also thinkable that our atomic brun units (fields) follow a gamma distribution with some α &gt; 1, in which case the most likely burn cost will be &gt;0. Thankfully, the aggregation behavour of k Gammas follows the exact same pattern as in the case of Exponentials.</p>
<p><strong>We do it for 3 different θ and 2 different α:</strong></p>
<div class="cell">

</div>
<div class="cell">
<div class="cell-output-display">
<p><img src="gamma_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="960"></p>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<p><img src="gamma_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid" width="960"></p>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<p><img src="gamma_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid" width="960"></p>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<p><img src="gamma_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="960"></p>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<p><img src="gamma_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid" width="960"></p>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<p><img src="gamma_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid" width="960"></p>
</div>
</div>
</section>
<section id="from-theory-to-practice-few-samples" class="level3">
<h3 class="anchored" data-anchor-id="from-theory-to-practice-few-samples">From Theory to Practice: few samples</h3>
<p>Until now, we used a monte carlo simulation of 50’000 draws, which means that our empirical observations come asymptotically close to the theory by the LLN. We want to understand now the behaviour of the aggregation with limited data.</p>
<p><strong>We do it for 3 different θ and 2 different α:</strong></p>
<div class="cell">

</div>
<div class="cell">
<div class="cell-output-display">
<p><img src="gamma_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid" width="960"></p>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<p><img src="gamma_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid" width="960"></p>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<p><img src="gamma_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid" width="960"></p>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<p><img src="gamma_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid" width="960"></p>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<p><img src="gamma_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid" width="960"></p>
</div>
</div>
<section id="aggregation-heals-mean-but-not-variance" class="level4">
<h4 class="anchored" data-anchor-id="aggregation-heals-mean-but-not-variance">Aggregation heals mean, but not variance</h4>
<p>In practice, we have only few years of observation (1-5), which is equivalent to our monte carlo with few draws. Our data, however, is composed if a large number of aggregated fields (certainly &gt;100), i.e.&nbsp;k is large. It’s important to note that the aggregation effect heals the mean (given i.i.d.), but NOT the variance.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="gamma_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid" width="960"></p>
</div>
</div>
<p>Worse even… as we increase k, sd gets smaller, but likely wrong.<strong>Hence we give ourselves a wrong confidence</strong></p>
<div class="cell">
<div class="cell-output-display">
<p><img src="gamma_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid" width="960"></p>
</div>
</div>
</section>
</section>
<section id="dependency-of-fields" class="level3">
<h3 class="anchored" data-anchor-id="dependency-of-fields">Dependency of Fields</h3>
<p>Attention. Our fields (ks) are almost certainly not independent. This has an impact on the aggregation behaviour. While they are not 100% dependent, we assume that they have some dependency Rho between 0 and 1. We simulate the</p>
<p><strong>simulate a selected scenario for 6 different dependencies:</strong></p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Called from: plot_gamma_dependent(draws, emp_average, theory, k, alpha, theta, 
    n_sims, rho)
debug: mean_emp &lt;- mean(emp_average$value)
debug: sd_emp &lt;- sd(emp_average$value)
debug: mean_theory &lt;- theta * alpha
debug: sd_theory &lt;- sqrt(alpha) * theta * (rho + (1 - rho)/sqrt(k))
debug: mx_y &lt;- theory$pdf %&gt;% max()
debug: sd_delta = (sd_emp - sd_theory)/sd_theory
debug: p &lt;- ggplot() + geom_freqpoly(data = atom_long, aes(value, after_stat(density), 
    group = id, colour = "k Fields Gamma(α,θ)"), binwidth = theta/50, 
    size = 0.2, show.legend = TRUE) + geom_density(data = emp_average, 
    aes(value, after_stat(density), colour = "Empirical avg"), 
    size = 1, show.legend = TRUE) + geom_line(data = theory, 
    aes(x, pdf, colour = "Gamma MM"), size = 1, show.legend = TRUE) + 
    geom_vline(aes(xintercept = mean_emp, colour = "Mean Draws"), 
        linetype = "dashed", size = 1) + geom_vline(aes(xintercept = mean_theory, 
    colour = "αθ"), linetype = "dashed", size = 1) + annotate("text", 
    x = theta * 2, y = mx_y, label = paste("sd empirical:", round(sd_emp, 
        3), "\nsd theory:", round(sd_theory, 3), "\nDelta:", 
        round(sd_delta * 100, 0), "%"), hjust = 0, vjust = 1, 
    size = 4, fontface = "italic") + scale_colour_manual(name = "", 
    values = c(`k Fields Gamma(α,θ)` = "grey70", `Empirical avg` = "steelblue", 
        `Gamma MM` = "red", `Mean Draws` = "darkgray", αθ = "darkred")) + 
    coord_cartesian(xlim = c(0, theta * 5), ylim = c(0, mx_y * 
        2)) + labs(title = paste0("Aggreg k=", k, " Fields Gamma(", 
    alpha, ",", theta, ") Rho =", rho), subtitle = paste0("Simulated ", 
    n_sims, " years"), x = "Burn", y = "density") + theme_minimal()
debug: p
debug: return(p)
Called from: plot_gamma_dependent(draws, emp_average, theory, k, alpha, theta, 
    n_sims, rho)
debug: mean_emp &lt;- mean(emp_average$value)
debug: sd_emp &lt;- sd(emp_average$value)
debug: mean_theory &lt;- theta * alpha
debug: sd_theory &lt;- sqrt(alpha) * theta * (rho + (1 - rho)/sqrt(k))
debug: mx_y &lt;- theory$pdf %&gt;% max()
debug: sd_delta = (sd_emp - sd_theory)/sd_theory
debug: p &lt;- ggplot() + geom_freqpoly(data = atom_long, aes(value, after_stat(density), 
    group = id, colour = "k Fields Gamma(α,θ)"), binwidth = theta/50, 
    size = 0.2, show.legend = TRUE) + geom_density(data = emp_average, 
    aes(value, after_stat(density), colour = "Empirical avg"), 
    size = 1, show.legend = TRUE) + geom_line(data = theory, 
    aes(x, pdf, colour = "Gamma MM"), size = 1, show.legend = TRUE) + 
    geom_vline(aes(xintercept = mean_emp, colour = "Mean Draws"), 
        linetype = "dashed", size = 1) + geom_vline(aes(xintercept = mean_theory, 
    colour = "αθ"), linetype = "dashed", size = 1) + annotate("text", 
    x = theta * 2, y = mx_y, label = paste("sd empirical:", round(sd_emp, 
        3), "\nsd theory:", round(sd_theory, 3), "\nDelta:", 
        round(sd_delta * 100, 0), "%"), hjust = 0, vjust = 1, 
    size = 4, fontface = "italic") + scale_colour_manual(name = "", 
    values = c(`k Fields Gamma(α,θ)` = "grey70", `Empirical avg` = "steelblue", 
        `Gamma MM` = "red", `Mean Draws` = "darkgray", αθ = "darkred")) + 
    coord_cartesian(xlim = c(0, theta * 5), ylim = c(0, mx_y * 
        2)) + labs(title = paste0("Aggreg k=", k, " Fields Gamma(", 
    alpha, ",", theta, ") Rho =", rho), subtitle = paste0("Simulated ", 
    n_sims, " years"), x = "Burn", y = "density") + theme_minimal()
debug: p
debug: return(p)
Called from: plot_gamma_dependent(draws, emp_average, theory, k, alpha, theta, 
    n_sims, rho)
debug: mean_emp &lt;- mean(emp_average$value)
debug: sd_emp &lt;- sd(emp_average$value)
debug: mean_theory &lt;- theta * alpha
debug: sd_theory &lt;- sqrt(alpha) * theta * (rho + (1 - rho)/sqrt(k))
debug: mx_y &lt;- theory$pdf %&gt;% max()
debug: sd_delta = (sd_emp - sd_theory)/sd_theory
debug: p &lt;- ggplot() + geom_freqpoly(data = atom_long, aes(value, after_stat(density), 
    group = id, colour = "k Fields Gamma(α,θ)"), binwidth = theta/50, 
    size = 0.2, show.legend = TRUE) + geom_density(data = emp_average, 
    aes(value, after_stat(density), colour = "Empirical avg"), 
    size = 1, show.legend = TRUE) + geom_line(data = theory, 
    aes(x, pdf, colour = "Gamma MM"), size = 1, show.legend = TRUE) + 
    geom_vline(aes(xintercept = mean_emp, colour = "Mean Draws"), 
        linetype = "dashed", size = 1) + geom_vline(aes(xintercept = mean_theory, 
    colour = "αθ"), linetype = "dashed", size = 1) + annotate("text", 
    x = theta * 2, y = mx_y, label = paste("sd empirical:", round(sd_emp, 
        3), "\nsd theory:", round(sd_theory, 3), "\nDelta:", 
        round(sd_delta * 100, 0), "%"), hjust = 0, vjust = 1, 
    size = 4, fontface = "italic") + scale_colour_manual(name = "", 
    values = c(`k Fields Gamma(α,θ)` = "grey70", `Empirical avg` = "steelblue", 
        `Gamma MM` = "red", `Mean Draws` = "darkgray", αθ = "darkred")) + 
    coord_cartesian(xlim = c(0, theta * 5), ylim = c(0, mx_y * 
        2)) + labs(title = paste0("Aggreg k=", k, " Fields Gamma(", 
    alpha, ",", theta, ") Rho =", rho), subtitle = paste0("Simulated ", 
    n_sims, " years"), x = "Burn", y = "density") + theme_minimal()
debug: p
debug: return(p)
Called from: plot_gamma_dependent(draws, emp_average, theory, k, alpha, theta, 
    n_sims, rho)
debug: mean_emp &lt;- mean(emp_average$value)
debug: sd_emp &lt;- sd(emp_average$value)
debug: mean_theory &lt;- theta * alpha
debug: sd_theory &lt;- sqrt(alpha) * theta * (rho + (1 - rho)/sqrt(k))
debug: mx_y &lt;- theory$pdf %&gt;% max()
debug: sd_delta = (sd_emp - sd_theory)/sd_theory
debug: p &lt;- ggplot() + geom_freqpoly(data = atom_long, aes(value, after_stat(density), 
    group = id, colour = "k Fields Gamma(α,θ)"), binwidth = theta/50, 
    size = 0.2, show.legend = TRUE) + geom_density(data = emp_average, 
    aes(value, after_stat(density), colour = "Empirical avg"), 
    size = 1, show.legend = TRUE) + geom_line(data = theory, 
    aes(x, pdf, colour = "Gamma MM"), size = 1, show.legend = TRUE) + 
    geom_vline(aes(xintercept = mean_emp, colour = "Mean Draws"), 
        linetype = "dashed", size = 1) + geom_vline(aes(xintercept = mean_theory, 
    colour = "αθ"), linetype = "dashed", size = 1) + annotate("text", 
    x = theta * 2, y = mx_y, label = paste("sd empirical:", round(sd_emp, 
        3), "\nsd theory:", round(sd_theory, 3), "\nDelta:", 
        round(sd_delta * 100, 0), "%"), hjust = 0, vjust = 1, 
    size = 4, fontface = "italic") + scale_colour_manual(name = "", 
    values = c(`k Fields Gamma(α,θ)` = "grey70", `Empirical avg` = "steelblue", 
        `Gamma MM` = "red", `Mean Draws` = "darkgray", αθ = "darkred")) + 
    coord_cartesian(xlim = c(0, theta * 5), ylim = c(0, mx_y * 
        2)) + labs(title = paste0("Aggreg k=", k, " Fields Gamma(", 
    alpha, ",", theta, ") Rho =", rho), subtitle = paste0("Simulated ", 
    n_sims, " years"), x = "Burn", y = "density") + theme_minimal()
debug: p
debug: return(p)
Called from: plot_gamma_dependent(draws, emp_average, theory, k, alpha, theta, 
    n_sims, rho)
debug: mean_emp &lt;- mean(emp_average$value)
debug: sd_emp &lt;- sd(emp_average$value)
debug: mean_theory &lt;- theta * alpha
debug: sd_theory &lt;- sqrt(alpha) * theta * (rho + (1 - rho)/sqrt(k))
debug: mx_y &lt;- theory$pdf %&gt;% max()
debug: sd_delta = (sd_emp - sd_theory)/sd_theory
debug: p &lt;- ggplot() + geom_freqpoly(data = atom_long, aes(value, after_stat(density), 
    group = id, colour = "k Fields Gamma(α,θ)"), binwidth = theta/50, 
    size = 0.2, show.legend = TRUE) + geom_density(data = emp_average, 
    aes(value, after_stat(density), colour = "Empirical avg"), 
    size = 1, show.legend = TRUE) + geom_line(data = theory, 
    aes(x, pdf, colour = "Gamma MM"), size = 1, show.legend = TRUE) + 
    geom_vline(aes(xintercept = mean_emp, colour = "Mean Draws"), 
        linetype = "dashed", size = 1) + geom_vline(aes(xintercept = mean_theory, 
    colour = "αθ"), linetype = "dashed", size = 1) + annotate("text", 
    x = theta * 2, y = mx_y, label = paste("sd empirical:", round(sd_emp, 
        3), "\nsd theory:", round(sd_theory, 3), "\nDelta:", 
        round(sd_delta * 100, 0), "%"), hjust = 0, vjust = 1, 
    size = 4, fontface = "italic") + scale_colour_manual(name = "", 
    values = c(`k Fields Gamma(α,θ)` = "grey70", `Empirical avg` = "steelblue", 
        `Gamma MM` = "red", `Mean Draws` = "darkgray", αθ = "darkred")) + 
    coord_cartesian(xlim = c(0, theta * 5), ylim = c(0, mx_y * 
        2)) + labs(title = paste0("Aggreg k=", k, " Fields Gamma(", 
    alpha, ",", theta, ") Rho =", rho), subtitle = paste0("Simulated ", 
    n_sims, " years"), x = "Burn", y = "density") + theme_minimal()
debug: p
debug: return(p)
Called from: plot_gamma_dependent(draws, emp_average, theory, k, alpha, theta, 
    n_sims, rho)
debug: mean_emp &lt;- mean(emp_average$value)
debug: sd_emp &lt;- sd(emp_average$value)
debug: mean_theory &lt;- theta * alpha
debug: sd_theory &lt;- sqrt(alpha) * theta * (rho + (1 - rho)/sqrt(k))
debug: mx_y &lt;- theory$pdf %&gt;% max()
debug: sd_delta = (sd_emp - sd_theory)/sd_theory
debug: p &lt;- ggplot() + geom_freqpoly(data = atom_long, aes(value, after_stat(density), 
    group = id, colour = "k Fields Gamma(α,θ)"), binwidth = theta/50, 
    size = 0.2, show.legend = TRUE) + geom_density(data = emp_average, 
    aes(value, after_stat(density), colour = "Empirical avg"), 
    size = 1, show.legend = TRUE) + geom_line(data = theory, 
    aes(x, pdf, colour = "Gamma MM"), size = 1, show.legend = TRUE) + 
    geom_vline(aes(xintercept = mean_emp, colour = "Mean Draws"), 
        linetype = "dashed", size = 1) + geom_vline(aes(xintercept = mean_theory, 
    colour = "αθ"), linetype = "dashed", size = 1) + annotate("text", 
    x = theta * 2, y = mx_y, label = paste("sd empirical:", round(sd_emp, 
        3), "\nsd theory:", round(sd_theory, 3), "\nDelta:", 
        round(sd_delta * 100, 0), "%"), hjust = 0, vjust = 1, 
    size = 4, fontface = "italic") + scale_colour_manual(name = "", 
    values = c(`k Fields Gamma(α,θ)` = "grey70", `Empirical avg` = "steelblue", 
        `Gamma MM` = "red", `Mean Draws` = "darkgray", αθ = "darkred")) + 
    coord_cartesian(xlim = c(0, theta * 5), ylim = c(0, mx_y * 
        2)) + labs(title = paste0("Aggreg k=", k, " Fields Gamma(", 
    alpha, ",", theta, ") Rho =", rho), subtitle = paste0("Simulated ", 
    n_sims, " years"), x = "Burn", y = "density") + theme_minimal()
debug: p
debug: return(p)</code></pre>
</div>
<div class="cell-output-display">
<p><img src="gamma_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="some-real-world-scenario" class="level3">
<h3 class="anchored" data-anchor-id="some-real-world-scenario">Some Real world scenario</h3>
<p>The real world with low years and dependency</p>
<p><strong>simulate a selected scenario for 6 different dependencies:</strong></p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Called from: plot_gamma_dependent(draws, emp_average, theory, k, alpha, theta, 
    n_sims, rho)
debug: mean_emp &lt;- mean(emp_average$value)
debug: sd_emp &lt;- sd(emp_average$value)
debug: mean_theory &lt;- theta * alpha
debug: sd_theory &lt;- sqrt(alpha) * theta * (rho + (1 - rho)/sqrt(k))
debug: mx_y &lt;- theory$pdf %&gt;% max()
debug: sd_delta = (sd_emp - sd_theory)/sd_theory
debug: p &lt;- ggplot() + geom_freqpoly(data = atom_long, aes(value, after_stat(density), 
    group = id, colour = "k Fields Gamma(α,θ)"), binwidth = theta/50, 
    size = 0.2, show.legend = TRUE) + geom_density(data = emp_average, 
    aes(value, after_stat(density), colour = "Empirical avg"), 
    size = 1, show.legend = TRUE) + geom_line(data = theory, 
    aes(x, pdf, colour = "Gamma MM"), size = 1, show.legend = TRUE) + 
    geom_vline(aes(xintercept = mean_emp, colour = "Mean Draws"), 
        linetype = "dashed", size = 1) + geom_vline(aes(xintercept = mean_theory, 
    colour = "αθ"), linetype = "dashed", size = 1) + annotate("text", 
    x = theta * 2, y = mx_y, label = paste("sd empirical:", round(sd_emp, 
        3), "\nsd theory:", round(sd_theory, 3), "\nDelta:", 
        round(sd_delta * 100, 0), "%"), hjust = 0, vjust = 1, 
    size = 4, fontface = "italic") + scale_colour_manual(name = "", 
    values = c(`k Fields Gamma(α,θ)` = "grey70", `Empirical avg` = "steelblue", 
        `Gamma MM` = "red", `Mean Draws` = "darkgray", αθ = "darkred")) + 
    coord_cartesian(xlim = c(0, theta * 5), ylim = c(0, mx_y * 
        2)) + labs(title = paste0("Aggreg k=", k, " Fields Gamma(", 
    alpha, ",", theta, ") Rho =", rho), subtitle = paste0("Simulated ", 
    n_sims, " years"), x = "Burn", y = "density") + theme_minimal()
debug: p
debug: return(p)
Called from: plot_gamma_dependent(draws, emp_average, theory, k, alpha, theta, 
    n_sims, rho)
debug: mean_emp &lt;- mean(emp_average$value)
debug: sd_emp &lt;- sd(emp_average$value)
debug: mean_theory &lt;- theta * alpha
debug: sd_theory &lt;- sqrt(alpha) * theta * (rho + (1 - rho)/sqrt(k))
debug: mx_y &lt;- theory$pdf %&gt;% max()
debug: sd_delta = (sd_emp - sd_theory)/sd_theory
debug: p &lt;- ggplot() + geom_freqpoly(data = atom_long, aes(value, after_stat(density), 
    group = id, colour = "k Fields Gamma(α,θ)"), binwidth = theta/50, 
    size = 0.2, show.legend = TRUE) + geom_density(data = emp_average, 
    aes(value, after_stat(density), colour = "Empirical avg"), 
    size = 1, show.legend = TRUE) + geom_line(data = theory, 
    aes(x, pdf, colour = "Gamma MM"), size = 1, show.legend = TRUE) + 
    geom_vline(aes(xintercept = mean_emp, colour = "Mean Draws"), 
        linetype = "dashed", size = 1) + geom_vline(aes(xintercept = mean_theory, 
    colour = "αθ"), linetype = "dashed", size = 1) + annotate("text", 
    x = theta * 2, y = mx_y, label = paste("sd empirical:", round(sd_emp, 
        3), "\nsd theory:", round(sd_theory, 3), "\nDelta:", 
        round(sd_delta * 100, 0), "%"), hjust = 0, vjust = 1, 
    size = 4, fontface = "italic") + scale_colour_manual(name = "", 
    values = c(`k Fields Gamma(α,θ)` = "grey70", `Empirical avg` = "steelblue", 
        `Gamma MM` = "red", `Mean Draws` = "darkgray", αθ = "darkred")) + 
    coord_cartesian(xlim = c(0, theta * 5), ylim = c(0, mx_y * 
        2)) + labs(title = paste0("Aggreg k=", k, " Fields Gamma(", 
    alpha, ",", theta, ") Rho =", rho), subtitle = paste0("Simulated ", 
    n_sims, " years"), x = "Burn", y = "density") + theme_minimal()
debug: p
debug: return(p)
Called from: plot_gamma_dependent(draws, emp_average, theory, k, alpha, theta, 
    n_sims, rho)
debug: mean_emp &lt;- mean(emp_average$value)
debug: sd_emp &lt;- sd(emp_average$value)
debug: mean_theory &lt;- theta * alpha
debug: sd_theory &lt;- sqrt(alpha) * theta * (rho + (1 - rho)/sqrt(k))
debug: mx_y &lt;- theory$pdf %&gt;% max()
debug: sd_delta = (sd_emp - sd_theory)/sd_theory
debug: p &lt;- ggplot() + geom_freqpoly(data = atom_long, aes(value, after_stat(density), 
    group = id, colour = "k Fields Gamma(α,θ)"), binwidth = theta/50, 
    size = 0.2, show.legend = TRUE) + geom_density(data = emp_average, 
    aes(value, after_stat(density), colour = "Empirical avg"), 
    size = 1, show.legend = TRUE) + geom_line(data = theory, 
    aes(x, pdf, colour = "Gamma MM"), size = 1, show.legend = TRUE) + 
    geom_vline(aes(xintercept = mean_emp, colour = "Mean Draws"), 
        linetype = "dashed", size = 1) + geom_vline(aes(xintercept = mean_theory, 
    colour = "αθ"), linetype = "dashed", size = 1) + annotate("text", 
    x = theta * 2, y = mx_y, label = paste("sd empirical:", round(sd_emp, 
        3), "\nsd theory:", round(sd_theory, 3), "\nDelta:", 
        round(sd_delta * 100, 0), "%"), hjust = 0, vjust = 1, 
    size = 4, fontface = "italic") + scale_colour_manual(name = "", 
    values = c(`k Fields Gamma(α,θ)` = "grey70", `Empirical avg` = "steelblue", 
        `Gamma MM` = "red", `Mean Draws` = "darkgray", αθ = "darkred")) + 
    coord_cartesian(xlim = c(0, theta * 5), ylim = c(0, mx_y * 
        2)) + labs(title = paste0("Aggreg k=", k, " Fields Gamma(", 
    alpha, ",", theta, ") Rho =", rho), subtitle = paste0("Simulated ", 
    n_sims, " years"), x = "Burn", y = "density") + theme_minimal()
debug: p
debug: return(p)
Called from: plot_gamma_dependent(draws, emp_average, theory, k, alpha, theta, 
    n_sims, rho)
debug: mean_emp &lt;- mean(emp_average$value)
debug: sd_emp &lt;- sd(emp_average$value)
debug: mean_theory &lt;- theta * alpha
debug: sd_theory &lt;- sqrt(alpha) * theta * (rho + (1 - rho)/sqrt(k))
debug: mx_y &lt;- theory$pdf %&gt;% max()
debug: sd_delta = (sd_emp - sd_theory)/sd_theory
debug: p &lt;- ggplot() + geom_freqpoly(data = atom_long, aes(value, after_stat(density), 
    group = id, colour = "k Fields Gamma(α,θ)"), binwidth = theta/50, 
    size = 0.2, show.legend = TRUE) + geom_density(data = emp_average, 
    aes(value, after_stat(density), colour = "Empirical avg"), 
    size = 1, show.legend = TRUE) + geom_line(data = theory, 
    aes(x, pdf, colour = "Gamma MM"), size = 1, show.legend = TRUE) + 
    geom_vline(aes(xintercept = mean_emp, colour = "Mean Draws"), 
        linetype = "dashed", size = 1) + geom_vline(aes(xintercept = mean_theory, 
    colour = "αθ"), linetype = "dashed", size = 1) + annotate("text", 
    x = theta * 2, y = mx_y, label = paste("sd empirical:", round(sd_emp, 
        3), "\nsd theory:", round(sd_theory, 3), "\nDelta:", 
        round(sd_delta * 100, 0), "%"), hjust = 0, vjust = 1, 
    size = 4, fontface = "italic") + scale_colour_manual(name = "", 
    values = c(`k Fields Gamma(α,θ)` = "grey70", `Empirical avg` = "steelblue", 
        `Gamma MM` = "red", `Mean Draws` = "darkgray", αθ = "darkred")) + 
    coord_cartesian(xlim = c(0, theta * 5), ylim = c(0, mx_y * 
        2)) + labs(title = paste0("Aggreg k=", k, " Fields Gamma(", 
    alpha, ",", theta, ") Rho =", rho), subtitle = paste0("Simulated ", 
    n_sims, " years"), x = "Burn", y = "density") + theme_minimal()
debug: p
debug: return(p)
Called from: plot_gamma_dependent(draws, emp_average, theory, k, alpha, theta, 
    n_sims, rho)
debug: mean_emp &lt;- mean(emp_average$value)
debug: sd_emp &lt;- sd(emp_average$value)
debug: mean_theory &lt;- theta * alpha
debug: sd_theory &lt;- sqrt(alpha) * theta * (rho + (1 - rho)/sqrt(k))
debug: mx_y &lt;- theory$pdf %&gt;% max()
debug: sd_delta = (sd_emp - sd_theory)/sd_theory
debug: p &lt;- ggplot() + geom_freqpoly(data = atom_long, aes(value, after_stat(density), 
    group = id, colour = "k Fields Gamma(α,θ)"), binwidth = theta/50, 
    size = 0.2, show.legend = TRUE) + geom_density(data = emp_average, 
    aes(value, after_stat(density), colour = "Empirical avg"), 
    size = 1, show.legend = TRUE) + geom_line(data = theory, 
    aes(x, pdf, colour = "Gamma MM"), size = 1, show.legend = TRUE) + 
    geom_vline(aes(xintercept = mean_emp, colour = "Mean Draws"), 
        linetype = "dashed", size = 1) + geom_vline(aes(xintercept = mean_theory, 
    colour = "αθ"), linetype = "dashed", size = 1) + annotate("text", 
    x = theta * 2, y = mx_y, label = paste("sd empirical:", round(sd_emp, 
        3), "\nsd theory:", round(sd_theory, 3), "\nDelta:", 
        round(sd_delta * 100, 0), "%"), hjust = 0, vjust = 1, 
    size = 4, fontface = "italic") + scale_colour_manual(name = "", 
    values = c(`k Fields Gamma(α,θ)` = "grey70", `Empirical avg` = "steelblue", 
        `Gamma MM` = "red", `Mean Draws` = "darkgray", αθ = "darkred")) + 
    coord_cartesian(xlim = c(0, theta * 5), ylim = c(0, mx_y * 
        2)) + labs(title = paste0("Aggreg k=", k, " Fields Gamma(", 
    alpha, ",", theta, ") Rho =", rho), subtitle = paste0("Simulated ", 
    n_sims, " years"), x = "Burn", y = "density") + theme_minimal()
debug: p
debug: return(p)
Called from: plot_gamma_dependent(draws, emp_average, theory, k, alpha, theta, 
    n_sims, rho)
debug: mean_emp &lt;- mean(emp_average$value)
debug: sd_emp &lt;- sd(emp_average$value)
debug: mean_theory &lt;- theta * alpha
debug: sd_theory &lt;- sqrt(alpha) * theta * (rho + (1 - rho)/sqrt(k))
debug: mx_y &lt;- theory$pdf %&gt;% max()
debug: sd_delta = (sd_emp - sd_theory)/sd_theory
debug: p &lt;- ggplot() + geom_freqpoly(data = atom_long, aes(value, after_stat(density), 
    group = id, colour = "k Fields Gamma(α,θ)"), binwidth = theta/50, 
    size = 0.2, show.legend = TRUE) + geom_density(data = emp_average, 
    aes(value, after_stat(density), colour = "Empirical avg"), 
    size = 1, show.legend = TRUE) + geom_line(data = theory, 
    aes(x, pdf, colour = "Gamma MM"), size = 1, show.legend = TRUE) + 
    geom_vline(aes(xintercept = mean_emp, colour = "Mean Draws"), 
        linetype = "dashed", size = 1) + geom_vline(aes(xintercept = mean_theory, 
    colour = "αθ"), linetype = "dashed", size = 1) + annotate("text", 
    x = theta * 2, y = mx_y, label = paste("sd empirical:", round(sd_emp, 
        3), "\nsd theory:", round(sd_theory, 3), "\nDelta:", 
        round(sd_delta * 100, 0), "%"), hjust = 0, vjust = 1, 
    size = 4, fontface = "italic") + scale_colour_manual(name = "", 
    values = c(`k Fields Gamma(α,θ)` = "grey70", `Empirical avg` = "steelblue", 
        `Gamma MM` = "red", `Mean Draws` = "darkgray", αθ = "darkred")) + 
    coord_cartesian(xlim = c(0, theta * 5), ylim = c(0, mx_y * 
        2)) + labs(title = paste0("Aggreg k=", k, " Fields Gamma(", 
    alpha, ",", theta, ") Rho =", rho), subtitle = paste0("Simulated ", 
    n_sims, " years"), x = "Burn", y = "density") + theme_minimal()
debug: p
debug: return(p)</code></pre>
</div>
<div class="cell-output-display">
<p><img src="gamma_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="take-aways-how-gammas-behave-in-our-setting" class="level3">
<h3 class="anchored" data-anchor-id="take-aways-how-gammas-behave-in-our-setting">Take aways: How Gammas Behave in our setting</h3>
<p>There is one very interesting mechanism to be understood. When Averaging k Gamma(α, θ) (or Exp(1/θ)), then by linearity of Expectation, E[X] of the k aggregated Gammas Gamma(αk, θ/k) remains the same as E[X] of 1 Gamma(α, θ). Obvious as k cancels out. However, the speciality of Gamma is that the shape parameter changes.</p>
<p>That’s why the Gamma example is interesting: it visibly illustrates how aggregation alters shape while preserving the mean.</p>
</section>
<section id="our-setting" class="level3">
<h3 class="anchored" data-anchor-id="our-setting">Our Setting</h3>
<p>Atomic unit = one insured field in one given year; its burn follows Exp(1/θ).</p>
<p>Region in one year = average of k such fields ⇒ Gamma(k, θ/k) burn.</p>
<p>Realisations(n_sims) = different years (or seasons); each year you draw a fresh Exp(θ) for every field.</p>
<div class="cell">

</div>
<p>The Gamma distribution in plain language What is it? A flexible curve for positive quantities (0 to ∞) that can look like a steep exponential, a gentle hump, or almost a bell—depending on two knobs. The two knobs • Shape (k) = how many “little pieces” add up. • Scale (θ) = average size of each piece. Mean = k θ, Variance = k θ². Everyday analogy Imagine a project that needs k independent mini-tasks, each taking a random time that averages θ days. Total duration = sum of those mini-tasks → that total is Gamma-shaped. Special cases • k = 1 ⇒ Exponential (memory-less waiting-time). • k = ½, θ = 2 ⇒ χ²(1). Large k ⇒ looks Normal (central-limit effect). Natural phenomena it matches – Total rainfall from many showers – Aggregate earthquake energy – Time until k failures in a machine – Insurance claim severity (right-skewed, non-negative) – Queueing/telecom traffic bursts Why actuaries &amp; engineers like it<br>
✅ Always non-negative  ✅ Closed-form mean/variance ✅ Simple additive property: if scale is equal, sums stay Gamma (handy for aggregation). Visual cheat-sheet • k &lt; 1 → spike near zero, heavy right tail (almost Exponential). • k ≈ 2–4 → single hump, moderate skew (looks like your burn-rate interior). • k ≫ 10 → nearly symmetric, nudging toward Normal. When to reach for it 1. Data are positive and skewed right. 2. Variability seems proportional to the square of the mean (variance grows with mean²). 3. You model a sum of identical Exponentials (waiting for the k-th event).</p>
</section>
<section id="only-the-positive-gammas" class="level3">
<h3 class="anchored" data-anchor-id="only-the-positive-gammas">Only the positive gammas</h3>
<div class="cell">

</div>
</section>
<section id="only-the-zero-gammas" class="level3">
<h3 class="anchored" data-anchor-id="only-the-zero-gammas">Only the zero gammas</h3>
<div class="cell">

</div>
</section>
<section id="only-the-5050-mix-gammas" class="level3">
<h3 class="anchored" data-anchor-id="only-the-5050-mix-gammas">Only the 5050 mix gammas</h3>
<div class="cell">

</div>
</section>
<section id="only-the-20-80-mix-gammas" class="level3">
<h3 class="anchored" data-anchor-id="only-the-20-80-mix-gammas">Only the 20 80 mix gammas</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co"># set.seed(123)</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co"># k &lt;- 10 # components per observation</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co"># n_zero &lt;- 8 # how many “small” Gammas</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co"># m &lt;- 5000 # sample size</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co"># # small-Gamma params</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co"># shape0 &lt;- 0.6</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="co"># scale0 &lt;- 0.05</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="co"># # positive-Gamma params</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="co"># shape1 &lt;- 3</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="co"># scale1 &lt;- 0.4</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="co"># sim &lt;- sim_mix(k, n_zero, m, shape0, scale0, shape1, scale1)</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="co"># par_mm &lt;- mom_gamma(n_zero, k, shape0, scale0, shape1, scale1)</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="co"># par_mle &lt;- fit_gamma_mle(sim$mix)</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="co"># ks_mm  &lt;- ks.test(sim$mix, "pgamma", shape = par_mm["shape"], scale = par_mm["scale"])</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="co"># ks_mle &lt;- ks.test(sim$mix, "pgamma", shape = par_mle["shape"], scale = par_mle["scale"])</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="co"># cat("KS p-value (moment-match) :", ks_mm$p.value, "\n")</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="co"># cat("KS p-value (MLE fit)     :", ks_mle$p.value, "\n\n")</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a><span class="co"># p &lt;- plot_gammas(sim, par_mm, par_mle, ks_mm, ks_mle)</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="co"># p</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="update-process-on-a-discrete-distribution" class="level3">
<h3 class="anchored" data-anchor-id="update-process-on-a-discrete-distribution">Update Process on a Discrete Distribution</h3>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>